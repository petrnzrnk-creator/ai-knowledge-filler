"""Unit tests for validate_yaml.py"""

import pytest
from Scripts.validate_yaml import validate_file, validate_date_format
import tempfile
import os


class TestDateValidation:
    """Test date format validation"""
    
    def test_valid_date_format(self):
        """Test that valid ISO 8601 dates pass validation"""
        assert validate_date_format('2026-02-10') == True
        assert validate_date_format('2024-01-01') == True
        assert validate_date_format('2025-12-31') == True
    
    def test_invalid_date_format_dd_mm_yyyy(self):
        """Test that DD-MM-YYYY format fails"""
        assert validate_date_format('10-02-2026') == False
        assert validate_date_format('01-01-2024') == False
    
    def test_invalid_date_format_slashes(self):
        """Test that date with slashes fails"""
        assert validate_date_format('2026/02/10') == False
        assert validate_date_format('10/02/2026') == False
    
    def test_invalid_date_value(self):
        """Test that invalid date values fail"""
        assert validate_date_format('2026-13-01') == False  # Invalid month
        assert validate_date_format('2026-02-30') == False  # Invalid day for Feb
    
    def test_invalid_date_feb_30(self):
        """Test that February 30 is invalid"""
        assert validate_date_format('2024-02-30') == False


class TestFileValidation:
    """Test validation of complete markdown files"""
    
    def test_valid_file(self):
        """Test validation of a completely valid file"""
        content = """---
title: "Test File"
type: guide
domain: ai-system
level: intermediate
status: active
tags: [tag1, tag2, tag3]
created: 2026-02-10
updated: 2026-02-10
---

# Content here
"""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.md', delete=False) as f:
            f.write(content)
            temp_path = f.name
        
        try:
            errors, warnings = validate_file(temp_path)
            assert len(errors) == 0
        finally:
            os.unlink(temp_path)
    
    def test_missing_frontmatter(self):
        """Test file without YAML frontmatter"""
        content = """# Just a markdown file
No YAML here"""
        
        with tempfile.NamedTemporaryFile(mode='w', suffix='.md', delete=False) as f:
            f.write(content)
            temp_path = f.name
        
        try:
            errors, warnings = validate_file(temp_path)
            assert len(errors) == 1
            assert 'No YAML frontmatter found' in errors[0]
        finally:
            os.unlink(temp_path)
    
    def test_missing_title_field(self):
        """Test file missing required title field"""
        content = """---
type: guide
domain: ai-system
level: intermediate
status: active
created: 2026-02-10
updated: 2026-02-10
---

# Content
"""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.md', delete=False) as f:
            f.write(content)
            temp_path = f.name
        
        try:
            errors, warnings = validate_file(temp_path)
            assert any('Missing required field: title' in err for err in errors)
        finally:
            os.unlink(temp_path)


# ==================== NEW TESTS BELOW ====================


class TestMetadataFieldValidation:
    """Test validation of specific metadata fields"""
    
    def test_invalid_type_field(self):
        """Test invalid type enum value"""
        content = """---
title: "Test File"
type: document
domain: ai-system
level: intermediate
status: active
tags: [tag1, tag2, tag3]
created: 2026-02-10
updated: 2026-02-10
---

# Content
"""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.md', delete=False) as f:
            f.write(content)
            temp_path = f.name
        
        try:
            errors, warnings = validate_file(temp_path)
            assert any('Invalid type' in err for err in errors)
        finally:
            os.unlink(temp_path)
    
    def test_invalid_level_field(self):
        """Test invalid level enum value"""
        content = """---
title: "Test File"
type: guide
domain: ai-system
level: medium
status: active
tags: [tag1, tag2, tag3]
created: 2026-02-10
updated: 2026-02-10
---

# Content
"""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.md', delete=False) as f:
            f.write(content)
            temp_path = f.name
        
        try:
            errors, warnings = validate_file(temp_path)
            assert any('Invalid level' in err for err in errors)
        finally:
            os.unlink(temp_path)
    
    def test_invalid_status_field(self):
        """Test invalid status enum value"""
        content = """---
title: "Test File"
type: guide
domain: ai-system
level: intermediate
status: in-progress
tags: [tag1, tag2, tag3]
created: 2026-02-10
updated: 2026-02-10
---

# Content
"""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.md', delete=False) as f:
            f.write(content)
            temp_path = f.name
        
        try:
            errors, warnings = validate_file(temp_path)
            assert any('Invalid status' in err for err in errors)
        finally:
            os.unlink(temp_path)
    
    def test_invalid_domain_warning(self):
        """Test warning for non-standard domain"""
        content = """---
title: "Test File"
type: guide
domain: custom-domain
level: intermediate
status: active
tags: [tag1, tag2, tag3]
created: 2026-02-10
updated: 2026-02-10
---

# Content
"""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.md', delete=False) as f:
            f.write(content)
            temp_path = f.name
        
        try:
            errors, warnings = validate_file(temp_path)
            assert len(errors) == 0  # No errors, just warning
            assert any('not in standard taxonomy' in warn for warn in warnings)
        finally:
            os.unlink(temp_path)
    
    def test_tags_not_array(self):
        """Test tags as string instead of array"""
        content = """---
title: "Test File"
type: guide
domain: ai-system
level: intermediate
status: active
tags: tag1, tag2, tag3
created: 2026-02-10
updated: 2026-02-10
---

# Content
"""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.md', delete=False) as f:
            f.write(content)
            temp_path = f.name
        
        try:
            errors, warnings = validate_file(temp_path)
            assert any('Tags must be an array' in err for err in errors)
        finally:
            os.unlink(temp_path)
    
    def test_related_not_array(self):
        """Test related as string instead of array"""
        content = """---
title: "Test File"
type: guide
domain: ai-system
level: intermediate
status: active
tags: [tag1, tag2, tag3]
related: "[[Some Link]]"
created: 2026-02-10
updated: 2026-02-10
---

# Content
"""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.md', delete=False) as f:
            f.write(content)
            temp_path = f.name
        
        try:
            errors, warnings = validate_file(temp_path)
            assert any('Related must be an array' in err for err in errors)
        finally:
            os.unlink(temp_path)
    
    def test_insufficient_tags_warning(self):
        """Test warning for fewer than 3 tags"""
        content = """---
title: "Test File"
type: guide
domain: ai-system
level: intermediate
status: active
tags: [tag1, tag2]
created: 2026-02-10
updated: 2026-02-10
---

# Content
"""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.md', delete=False) as f:
            f.write(content)
            temp_path = f.name
        
        try:
            errors, warnings = validate_file(temp_path)
            assert len(errors) == 0
            assert any('Fewer than 3 tags' in warn for warn in warnings)
        finally:
            os.unlink(temp_path)
    
    def test_no_related_links_warning(self):
        """Test warning when related links are missing"""
        content = """---
title: "Test File"
type: guide
domain: ai-system
level: intermediate
status: active
tags: [tag1, tag2, tag3]
created: 2026-02-10
updated: 2026-02-10
---

# Content
"""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.md', delete=False) as f:
            f.write(content)
            temp_path = f.name
        
        try:
            errors, warnings = validate_file(temp_path)
            assert len(errors) == 0
            assert any('No related links' in warn for warn in warnings)
        finally:
            os.unlink(temp_path)


class TestYAMLParsingErrors:
    """Test YAML parsing edge cases"""
    
    def test_malformed_yaml(self):
        """Test file with malformed YAML"""
        content = """---
title: "Test File"
type: guide
domain: ai-system
level: intermediate
  indented_incorrectly: value
status: active
---

# Content
"""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.md', delete=False) as f:
            f.write(content)
            temp_path = f.name
        
        try:
            errors, warnings = validate_file(temp_path)
            assert any('YAML parsing error' in err for err in errors)
        finally:
            os.unlink(temp_path)
    
    def test_empty_yaml_frontmatter(self):
        """Test file with empty YAML frontmatter"""
        content = """---
---

# Content
"""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.md', delete=False) as f:
            f.write(content)
            temp_path = f.name
        
        try:
            errors, warnings = validate_file(temp_path)
            assert any('Empty YAML frontmatter' in err for err in errors)
        finally:
            os.unlink(temp_path)
    
    def test_incomplete_frontmatter(self):
        """Test file with incomplete YAML structure"""
        content = """---
title: "Test File"
type: guide

# Content starts without closing ---
"""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.md', delete=False) as f:
            f.write(content)
            temp_path = f.name
        
        try:
            errors, warnings = validate_file(temp_path)
            assert any('Invalid YAML frontmatter structure' in err for err in errors)
        finally:
            os.unlink(temp_path)


class TestMultipleFieldErrors:
    """Test files with multiple validation errors"""
    
    def test_multiple_missing_fields(self):
        """Test file missing multiple required fields"""
        content = """---
title: "Test File"
type: guide
---

# Content
"""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.md', delete=False) as f:
            f.write(content)
            temp_path = f.name
        
        try:
            errors, warnings = validate_file(temp_path)
            # Should have errors for missing: domain, level, status, created, updated
            assert len(errors) >= 5
            assert any('Missing required field: domain' in err for err in errors)
            assert any('Missing required field: level' in err for err in errors)
            assert any('Missing required field: status' in err for err in errors)
        finally:
            os.unlink(temp_path)
    
    def test_multiple_invalid_values(self):
        """Test file with multiple invalid enum values"""
        content = """---
title: "Test File"
type: tutorial
domain: Technology
level: expert
status: wip
tags: single-tag
created: 2026-02-10
updated: 2026-02-10
---

# Content
"""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.md', delete=False) as f:
            f.write(content)
            temp_path = f.name
        
        try:
            errors, warnings = validate_file(temp_path)
            # Should have multiple errors
            assert len(errors) >= 4
            assert any('Invalid type' in err for err in errors)
            assert any('Invalid level' in err for err in errors)
            assert any('Invalid status' in err for err in errors)
            assert any('Tags must be an array' in err for err in errors)
        finally:
            os.unlink(temp_path)
